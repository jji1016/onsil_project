<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>장바구니 가상구현</title>
    <style>
        body { font-family: '맑은 고딕', sans-serif; margin: 40px; }
        table { border-collapse: collapse; width: 80%; margin-bottom: 30px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f5f5f5; }
        .btn { padding: 4px 12px; margin: 2px; }
        #pay-btn { margin-top: 30px; padding: 10px 30px; font-size: 18px; background: #2a7; color: #fff; border: none; border-radius: 6px; cursor: pointer;}
        #pay-btn:active { background: #185; }
    </style>
</head>
<body>
<h1>장바구니</h1>
<div>
    <label>회원번호: <input type="number" id="memberId" value="1" style="width:60px;"></label>
    <button onclick="loadCart()">장바구니 조회</button>
    <button onclick="clearCart()">장바구니 전체 비우기</button>
</div>
<div id="cart-summary"></div>
<table id="cart-table">
    <thead>
    <tr>
        <th>상품명</th><th>가격</th><th>수량</th><th>이미지</th><th>닉네임</th><th>수정/삭제</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>
<div>
    <h3>상품 추가</h3>
    <label>상품명: <input type="text" id="flowerName" style="width:120px;"></label>
    <label>수량: <input type="number" id="quantity" value="1" style="width:40px;"></label>
    <button onclick="addToCart()">추가</button>
</div>
<!-- 결제하기 버튼 추가 -->
<div style="text-align:center;">
    <button id="pay-btn" onclick="goToPayment()">결제하기</button>
</div>
<script>
    async function loadCart() {
        const memberId = document.getElementById('memberId').value;
        const res = await fetch(`/api/cart/${memberId}`);
        const items = await res.json();
        const tbody = document.querySelector('#cart-table tbody');
        tbody.innerHTML = '';
        items.forEach(item => {
            tbody.innerHTML += `
                    <tr>
                        <td>${item.flowerName}</td>
                        <td>${item.price}</td>
                        <td>
                            <input type="number" value="${item.quantity}" min="1" style="width:40px;"
                                onchange="updateQuantity(${item.cartId}, this.value)">
                        </td>
                        <td><img src="${item.image}" alt="" style="width:60px;"></td>
                        <td>${item.memberNickName}</td>
                        <td>
                            <button class="btn" onclick="removeFromCart(${item.cartId})">삭제</button>
                        </td>
                    </tr>
                `;
        });

        // 합계/배송비
        const summaryRes = await fetch(`/api/cart/${memberId}/summary`);
        const summary = await summaryRes.json();
        document.getElementById('cart-summary').innerHTML =
            `<b>총액:</b> ${summary.totalPrice}원, <b>배송비:</b> ${summary.deliveryFee}원, <b>결제예정:</b> ${summary.finalPrice}원`;

        // 결제하기 버튼에 memberId, finalPrice 저장
        document.getElementById('pay-btn').dataset.memberId = memberId;
        document.getElementById('pay-btn').dataset.finalPrice = summary.finalPrice;
    }

    async function addToCart() {
        const memberId = document.getElementById('memberId').value;
        const flowerName = document.getElementById('flowerName').value;
        const quantity = document.getElementById('quantity').value;
        await fetch(`/api/cart?memberId=${memberId}&flowerName=${encodeURIComponent(flowerName)}&quantity=${quantity}`, {
            method: 'POST'
        });
        loadCart();
    }

    async function updateQuantity(cartId, quantity) {
        await fetch(`/api/cart/${cartId}?quantity=${quantity}`, {
            method: 'PUT'
        });
        loadCart();
    }

    async function removeFromCart(cartId) {
        await fetch(`/api/cart/${cartId}`, { method: 'DELETE' });
        loadCart();
    }

    async function clearCart() {
        const memberId = document.getElementById('memberId').value;
        await fetch(`/api/cart/clear/${memberId}`, { method: 'DELETE' });
        loadCart();
    }

    // 결제하기 버튼 클릭 시 결제창으로 이동 (memberId, finalPrice 전달)
    function goToPayment() {
        const btn = document.getElementById('pay-btn');
        const memberId = btn.dataset.memberId;
        const finalPrice = btn.dataset.finalPrice;
        // 쿼리스트링으로 전달 (실제 서비스라면 세션/localStorage 등도 가능)
        window.location.href = `payment.html?memberId=${memberId}&finalPrice=${finalPrice}`;
    }

    // 페이지 로딩 시 자동 조회
    window.onload = loadCart;
</script>
</body>
</html>
